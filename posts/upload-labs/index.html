<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  
  <title>upload-labs 通关笔记</title>
  <meta property="og:title" content="upload-labs 通关笔记" />
  <meta name="twitter:title" content="upload-labs 通关笔记" />
  

  

  <link rel="stylesheet" href="localhost/css/style.css" />
  <style type="text/css">
  /* generic table stuff */
table, th, td {
  border: 1px solid #008B8B;
}

th {
  background: #3B0072;
  background-color: #3B0072;
  color: #FF040C;
}

/* generic headers */
h1{
  color: #FF00FF;
  text-decoration: none;
}
h2{
  color: #DA70D6;
  text-decoration: none;
}
h3{
  color: #EE82EE;
  text-decoration: none;
}
h4{
  color: #8B008B;
  text-decoration: none;
}
h5{
  color: #9932CC;
  text-decoration: none;
}
h6{
  color: #800080;
  text-decoration: none;
}

/* Changes */
#main{
    border-radius: 0.15%;
    padding: 15px 20px;
    background: #101010;
}

.p-title__link {
    color: #FF1493;
}

.p-title__link:hover {
    color: #66FF00;
}

/* Base style */

body {
    color: #66FF00;
    background: #101010;;
    line-height: 1.57
    font-size: 1.0rem;
    font-family: -apple-system, BlinkMacSystemFont, YakuHanJP, Hiragino Kaku Gothic ProN, Meiryo, sans-serif;
}

a {
    color: #FFF;
    text-decoration: none;
}

a:hover {
    color: #FF1493;
     text-decoration: underline;
}

pre {
    display: block;
    padding: 12px;
    border-radius: 3px;
    background-color: #101010;
    font-size: 1.2rem;
    word-wrap: break-word;
    overflow: auto
}

code {
    line-height: 1.8;
    font-size: 1.4rem
    background: #100110;
}

blockquote {
    margin: 0;
    padding: 8px 12px;
    border-left: 3px solid #66FF00
    background: #100100;
}

.c-links a {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    width: 30px;
    height: 30px;
    border: 1px solid;
    border-color: #555;
    border-radius: 50%;
    color: #FF1493;
    transition: .2s
}

.c-links a:hover {
    background: #101010;
    color: #FF1493;
}

.c-links__icon {
    width: 16px;
    height: 16px;
    fill: #ccc;
}

.c-article__title a {
    color: #FF1493;
}

.c-article__title a:hover {
    color: #66FF00;
}

.c-article__summary {
    font-size: 1.4rem;
    color: #66FF00;
    line-height: 1.57
}

.c-tag {
    display: inline-block;
    margin: 8px 6px 0 0;
    padding: 4px;
    font-size: 1.6rem;
    color: #FF00FF;
}

.c-tag:hover {
    background: #101010;
    color: #66FF00;
}

.c-pagination a:hover {
    background: #101010;
}

.p-tag-title {
    display: inline-block;
    margin: 0;
    padding-bottom: 8px;
    border-bottom: 1px solid currentColor;
    color: #FF1493;;
    font-size: 2.4rem
}

/* Menu styles - change */

.p-menu {
    width: 100%;
    background: #000;
    padding-top: 12px;
    padding-bottom: 14px;
    display: inline-block;
    /* NOTE: should make this its own thing, most likely */
    
}

.p-menu__parent span {
    color: #66FF00;
}

.p-author:before {
    content: "* * *";
    position: absolute;
    top: -30px;
    left: 0;
    right: 0;
    margin: auto;
    text-align: center;
    font-size: 1.4rem;
    color: #66FF00;
}

.p-screen-reader-text:hover,
.p-screen-reader-text:active,
.p-screen-reader-text:focus {
    background-color: #101010;;
    border-radius: 3px;
    box-shadow: 0 0 2px 2px rgba(0, 0, 0, .6);
    clip: auto!important;
    color: #66FF00;
    display: block;
    font-size: 14px;
    font-size: .875rem;
    font-weight: 700;
    height: auto;
    left: 5px;
    line-height: normal;
    padding: 15px 23px 14px;
    text-decoration: none;
    top: 5px;
    width: auto;
    z-index: 100000
}

.p-related__item a {
    position: relative;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    width: 100%;
    height: 100%;
    padding: 8px;
    background-size: cover;
    background-color: #101010;
    color: #66FF00;
    font-weight: 400;
    font-family: Open Sans, sans-serif
}

.p-related__item a:before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, .3);
    transition: .1s
}

.p-related__item a:hover:before {
    background: rgba(0, 0, 0, .6)
}

/* Slick css */

.slick-arrow {
    position: absolute;
    top: 0;
    bottom: 0;
    margin: auto;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: #101010;
}

.slick-arrow:after {
    content: "";
    display: inline-block;
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    margin: auto;
    width: 5px;
    height: 5px;
    border: solid #66FF00;
}


/* C3 overrides so bits are not invisible */

.c3 path, .c3 line {
  stroke: #66FF00;
}

.c3 text {
  stroke: #FF00FF;
}

.c3-tooltip td {
  background-color: #101010;
}

  </style>
  <script type="text/javascript" src="localhost/js/bundle.js"></script>
  
  
  

</head>

<body>
  <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;" aria-hidden="true"> <symbol id="icon-500px" viewBox="0 0 16 16"><g> <path d="M3.953 10.512a5.24 5.24 0 0 0 6.996 3.141c.625-.262 1.184-.641 1.666-1.122s.859-1.041 1.122-1.666c.272-.647.412-1.331.412-2.037s-.137-1.394-.412-2.037c-.262-.625-.641-1.184-1.122-1.666s-1.041-.859-1.666-1.122a5.226 5.226 0 0 0-2.037-.413c-.716 0-1.431.144-2.066.413-.509.216-1.372.769-1.875 1.291l-.003.003V.984h7.241c.262-.003.262-.372.262-.491 0-.122 0-.487-.266-.491H4.377a.343.343 0 0 0-.344.341v6.066c0 .197.244.338.472.384.444.094.544-.047.653-.197l.016-.019c.166-.247.681-.766.688-.772a4.262 4.262 0 0 1 3.037-1.25c1.147 0 2.222.444 3.028 1.25a4.245 4.245 0 0 1 1.256 3.019 4.236 4.236 0 0 1-1.25 3.019 4.336 4.336 0 0 1-3.047 1.25 4.136 4.136 0 0 1-2.159-.597l.003-3.688c0-.491.213-1.028.572-1.431a2.09 2.09 0 0 1 1.588-.716c.594 0 1.15.225 1.566.634.409.406.637.95.637 1.528a2.179 2.179 0 0 1-2.206 2.197c-.238 0-.672-.106-.691-.109-.25-.075-.356.272-.391.387-.134.441.069.528.109.541.397.125.659.147 1.003.147a3.173 3.173 0 0 0 3.169-3.169c0-1.734-1.422-3.144-3.166-3.144-.856 0-1.659.328-2.263.919-.575.566-.903 1.319-.903 2.069v.019c-.003.094-.003 2.306-.006 3.031l-.003-.003c-.328-.363-.653-.919-.869-1.488-.084-.222-.275-.184-.534-.103-.125.034-.469.141-.391.394zm3.722-.865c0 .106.097.2.156.253l.019.019c.1.097.194.147.281.147a.181.181 0 0 0 .131-.05c.044-.041.537-.544.588-.591l.553.55c.05.056.106.088.172.088.088 0 .184-.053.284-.156.238-.244.119-.375.063-.438l-.559-.559.584-.588c.128-.137.016-.284-.097-.397-.162-.162-.322-.206-.422-.112l-.581.581-.588-.588a.16.16 0 0 0-.113-.047c-.078 0-.172.053-.275.156-.181.181-.219.306-.125.406l.588.584-.584.584c-.053.05-.078.103-.075.156zm1.278-7.931c-.938 0-1.938.191-2.669.506a.207.207 0 0 0-.134.181.753.753 0 0 0 .069.337c.047.116.166.425.4.334a6.689 6.689 0 0 1 2.334-.444 6.35 6.35 0 0 1 2.469.497c.622.263 1.206.644 1.844 1.194a.22.22 0 0 0 .147.059c.125 0 .244-.122.347-.237.169-.191.287-.35.119-.509a6.858 6.858 0 0 0-2.1-1.356 7.326 7.326 0 0 0-2.825-.563zM14.006 13.3c-.113-.113-.209-.178-.294-.203s-.162-.006-.222.053l-.056.056a6.32 6.32 0 0 1-6.938 1.356 6.336 6.336 0 0 1-2.013-1.356 6.046 6.046 0 0 1-1.356-2.012c-.288-.713-.381-1.247-.413-1.422-.003-.016-.006-.028-.006-.037-.041-.206-.231-.222-.503-.178-.112.019-.459.072-.428.319v.006a7.261 7.261 0 0 0 2.04 3.994 7.266 7.266 0 0 0 10.288 0l.059-.059c.069-.084.134-.225-.159-.516z"/> </g></symbol> <symbol id="icon-codepen" viewBox="0 0 16 16"><g> <path d="M14.777 5.751l-7-4.667a.5.5 0 0 0-.555 0l-7 4.667a.501.501 0 0 0-.223.416v4.667c0 .167.084.323.223.416l7 4.667a.5.5 0 0 0 .554 0l7-4.667a.501.501 0 0 0 .223-.416V6.167a.501.501 0 0 0-.223-.416zM7.5 10.232L4.901 8.5 7.5 6.768 10.099 8.5 7.5 10.232zM8 5.899V2.434l5.599 3.732L11 7.898l-3-2zm-1 0l-3 2-2.599-1.732L7 2.435V5.9zM3.099 8.5L1 9.899V7.101L3.099 8.5zM4 9.101l3 2v3.465l-5.599-3.732L4 9.102zm4 2l3-2 2.599 1.732L8 14.565V11.1zM11.901 8.5L14 7.101v2.798L11.901 8.5z"/> </g></symbol> <symbol id="icon-dribbble" viewBox="0 0 16 16"><g> <path d="M8 16c-4.412 0-8-3.588-8-8s3.587-8 8-8c4.412 0 8 3.587 8 8s-3.588 8-8 8zm6.747-6.906c-.234-.075-2.116-.634-4.256-.291a29.7 29.7 0 0 1 1.328 4.872 6.845 6.845 0 0 0 2.928-4.581zM10.669 14.3c-.103-.6-.497-2.688-1.456-5.181-.016.006-.031.009-.044.016-3.856 1.344-5.241 4.016-5.362 4.266a6.807 6.807 0 0 0 6.863.9zm-7.747-1.722c.156-.266 2.031-3.369 5.553-4.509a7.04 7.04 0 0 1 .269-.081 24.04 24.04 0 0 0-.553-1.159c-3.409 1.022-6.722.978-7.022.975-.003.069-.003.138-.003.209 0 1.753.666 3.356 1.756 4.566zM1.313 6.609c.306.003 3.122.016 6.319-.831a43.092 43.092 0 0 0-2.534-3.953 6.854 6.854 0 0 0-3.784 4.784zM6.4 1.366a36.612 36.612 0 0 1 2.55 4c2.431-.909 3.459-2.294 3.581-2.469A6.799 6.799 0 0 0 6.4 1.366zm6.891 2.325c-.144.194-1.291 1.663-3.816 2.694.159.325.313.656.453.991.05.119.1.234.147.353 2.275-.284 4.534.172 4.759.219a6.816 6.816 0 0 0-1.544-4.256z"/> </g></symbol> <symbol id="icon-facebook" viewBox="0 0 16 16"><g> <path d="M9.5 3H12V0H9.5C7.57 0 6 1.57 6 3.5V5H4v3h2v8h3V8h2.5l.5-3H9V3.5c0-.271.229-.5.5-.5z"/> </g></symbol> <symbol id="icon-feed" viewBox="0 0 16 16"><g> <path d="M2.13 11.733c-1.175 0-2.13.958-2.13 2.126 0 1.174.955 2.122 2.13 2.122a2.126 2.126 0 0 0 2.133-2.122 2.133 2.133 0 0 0-2.133-2.126zM.002 5.436v3.067c1.997 0 3.874.781 5.288 2.196a7.45 7.45 0 0 1 2.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006 0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824 0 .006 0z"/> </g></symbol> <symbol id="icon-flickr" viewBox="0 0 16 16"><g> <path d="M0 8.5a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0zm9 0a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/> </g></symbol> <symbol id="icon-github" viewBox="0 0 16 16"><g> <path d="M8 .198a8 8 0 0 0-2.529 15.591c.4.074.547-.174.547-.385 0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954 0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117 0 0 .672-.215 2.201.82A7.672 7.672 0 0 1 8 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147 0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481 0 1.07-.009 1.932-.009 2.195 0 .213.144.462.55.384A8 8 0 0 0 8.001.196z"/> </g></symbol> <symbol id="icon-gitlab" viewBox="0 0 28 28"><g> <path d="M1.625 11.031L14 26.89.437 17.046a1.092 1.092 0 0 1-.391-1.203l1.578-4.813zm7.219 0h10.313L14.001 26.89zM5.75 1.469l3.094 9.562H1.625l3.094-9.562a.548.548 0 0 1 1.031 0zm20.625 9.562l1.578 4.813a1.09 1.09 0 0 1-.391 1.203l-13.563 9.844 12.375-15.859zm0 0h-7.219l3.094-9.562a.548.548 0 0 1 1.031 0z"/> </g></symbol> <symbol id="icon-google-plus" viewBox="0 0 16 16"><g> <path d="M5.091 7.147v1.747h2.888c-.116.75-.872 2.197-2.888 2.197-1.737 0-3.156-1.441-3.156-3.216s1.419-3.216 3.156-3.216c.991 0 1.65.422 2.028.784L8.5 4.112c-.888-.828-2.037-1.331-3.409-1.331C2.275 2.784 0 5.059 0 7.875s2.275 5.091 5.091 5.091c2.937 0 4.888-2.066 4.888-4.975 0-.334-.037-.591-.081-.844H5.092zM16 7h-1.5V5.5H13V7h-1.5v1.5H13V10h1.5V8.5H16z"/> </g></symbol> <symbol id="icon-google" viewBox="0 0 16 16"><g> <path d="M8.159 6.856V9.6h4.537c-.184 1.178-1.372 3.45-4.537 3.45C5.428 13.05 3.2 10.788 3.2 8s2.228-5.05 4.959-5.05c1.553 0 2.594.663 3.188 1.234l2.172-2.091C12.125.787 10.319-.001 8.16-.001c-4.422 0-8 3.578-8 8s3.578 8 8 8c4.616 0 7.681-3.247 7.681-7.816 0-.525-.056-.925-.125-1.325L8.16 6.855z"/> </g></symbol> <symbol id="icon-instagram" viewBox="0 0 22 22"><g> <path d="M15.445 0H6.554A6.559 6.559 0 0 0 0 6.554v8.891A6.559 6.559 0 0 0 6.554 22h8.891a6.56 6.56 0 0 0 6.554-6.555V6.554A6.557 6.557 0 0 0 15.445 0zm4.342 15.445a4.343 4.343 0 0 1-4.342 4.342H6.554a4.341 4.341 0 0 1-4.341-4.342V6.554a4.34 4.34 0 0 1 4.341-4.341h8.891a4.342 4.342 0 0 1 4.341 4.341l.001 8.891z"/> <path d="M11 5.312A5.693 5.693 0 0 0 5.312 11 5.694 5.694 0 0 0 11 16.688 5.694 5.694 0 0 0 16.688 11 5.693 5.693 0 0 0 11 5.312zm0 9.163a3.475 3.475 0 1 1-.001-6.95 3.475 3.475 0 0 1 .001 6.95zm5.7-10.484a1.363 1.363 0 1 1-1.364 1.364c0-.752.51-1.364 1.364-1.364z"/> </g></symbol> <symbol id="icon-linkedin" viewBox="0 0 16 16"><g> <path d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502 0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5a1.5 1.5 0 1 1-3.001-.001A1.5 1.5 0 0 1 4 3.5z"/> </g></symbol> <symbol id="icon-mail" viewBox="0 0 22 18"><g> <path fill="#000" d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275l5.077-5.09L1.795 3.98v10.155zm13.332-5.09l5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588l8.022-8.027-16.045-.001 8.023 8.028z"/> </g></symbol> <symbol id="icon-npm" viewBox="0 0 16 16"><g> <path d="M0 0v16h16V0H0zm13 13h-2V5H8v8H3V3h10v10z"/> </g></symbol> <symbol id="icon-pinterest" viewBox="0 0 16 16"><g> <path d="M8 1.069a6.93 6.93 0 0 0-2.525 13.384c-.059-.547-.116-1.391.025-1.988.125-.541.813-3.444.813-3.444s-.206-.416-.206-1.028c0-.963.559-1.684 1.253-1.684.591 0 .878.444.878.975 0 .594-.378 1.484-.575 2.306-.166.691.344 1.253 1.025 1.253 1.231 0 2.178-1.3 2.178-3.175 0-1.659-1.194-2.819-2.894-2.819-1.972 0-3.128 1.478-3.128 3.009 0 .597.228 1.234.516 1.581.056.069.066.128.047.2a95.89 95.89 0 0 1-.194.787c-.031.128-.1.153-.231.094-.866-.403-1.406-1.669-1.406-2.684 0-2.188 1.587-4.194 4.578-4.194 2.403 0 4.272 1.712 4.272 4.003 0 2.388-1.506 4.313-3.597 4.313-.703 0-1.362-.366-1.588-.797 0 0-.347 1.322-.431 1.647-.156.603-.578 1.356-.862 1.816a6.93 6.93 0 0 0 8.984-6.622 6.931 6.931 0 0 0-6.931-6.934z"/> </g></symbol> <symbol id="icon-pushpin" viewBox="0 0 16 16"><g> <path d="M8.5 0L7 1.5 8.5 3 5 7H1.5l2.75 2.75L0 15.385V16h.615l5.635-4.25L9 14.5V11l4-3.5L14.5 9 16 7.5 8.5 0zM7 8.5l-1-1L9.5 4l1 1L7 8.5z"/> </g></symbol> <symbol id="icon-search" viewBox="0 0 16 16"><g> <path d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 1 0-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/> </g></symbol> <symbol id="icon-tumblr" viewBox="0 0 16 16"><g> <path d="M9.001 7v3.659c0 .928-.012 1.463.086 1.727.098.262.342.534.609.691.354.212.758.318 1.214.318.81 0 1.289-.107 2.09-.633v2.405a9.089 9.089 0 0 1-1.833.639A7.93 7.93 0 0 1 9.369 16a4.9 4.9 0 0 1-1.725-.276 4.195 4.195 0 0 1-1.438-.79c-.398-.343-.672-.706-.826-1.091s-.23-.944-.23-1.676V6.556H3.003V4.29c.628-.204 1.331-.497 1.778-.877a4.386 4.386 0 0 0 1.08-1.374C6.133 1.505 6.32.825 6.422 0h2.579v4H13v3H9.001z"/> </g></symbol> <symbol id="icon-twitter" viewBox="0 0 16 16"><g> <path d="M16 3.538a6.461 6.461 0 0 1-1.884.516 3.301 3.301 0 0 0 1.444-1.816 6.607 6.607 0 0 1-2.084.797 3.28 3.28 0 0 0-2.397-1.034 3.28 3.28 0 0 0-3.197 4.028 9.321 9.321 0 0 1-6.766-3.431 3.284 3.284 0 0 0 1.015 4.381A3.301 3.301 0 0 1 .643 6.57v.041A3.283 3.283 0 0 0 3.277 9.83a3.291 3.291 0 0 1-1.485.057 3.293 3.293 0 0 0 3.066 2.281 6.586 6.586 0 0 1-4.862 1.359 9.286 9.286 0 0 0 5.034 1.475c6.037 0 9.341-5.003 9.341-9.341 0-.144-.003-.284-.009-.425a6.59 6.59 0 0 0 1.637-1.697z"/> </g></symbol> <symbol id="icon-vimeo" viewBox="0 0 16 16"><g> <path d="M15.994 4.281c-.072 1.556-1.159 3.691-3.263 6.397-2.175 2.825-4.016 4.241-5.522 4.241-.931 0-1.722-.859-2.366-2.581-.431-1.578-.859-3.156-1.291-4.734-.478-1.722-.991-2.581-1.541-2.581-.119 0-.538.253-1.256.753l-.753-.969c.791-.694 1.569-1.388 2.334-2.081 1.053-.909 1.844-1.387 2.372-1.438 1.244-.119 2.013.731 2.3 2.553.309 1.966.525 3.188.647 3.666.359 1.631.753 2.447 1.184 2.447.334 0 .838-.528 1.509-1.588.669-1.056 1.028-1.862 1.078-2.416.097-.912-.262-1.372-1.078-1.372a2.98 2.98 0 0 0-1.184.263c.787-2.575 2.287-3.825 4.506-3.753 1.641.044 2.416 1.109 2.322 3.194z"/> </g></symbol> <symbol id="icon-wordpress" viewBox="0 0 16 16"><g> <path d="M2 8c0 2.313 1.38 4.312 3.382 5.259L2.52 5.622A5.693 5.693 0 0 0 2 8zm10.05-.295c0-.722-.266-1.222-.495-1.612-.304-.482-.589-.889-.589-1.371 0-.537.418-1.037 1.008-1.037.027 0 .052.003.078.005A6.064 6.064 0 0 0 8 2.156 6.036 6.036 0 0 0 2.987 4.79c.141.004.274.007.386.007.627 0 1.599-.074 1.599-.074.323-.018.361.444.038.482 0 0-.325.037-.687.055l2.185 6.33 1.313-3.835-.935-2.495a12.304 12.304 0 0 1-.629-.055c-.323-.019-.285-.5.038-.482 0 0 .991.074 1.58.074.627 0 1.599-.074 1.599-.074.323-.018.362.444.038.482 0 0-.326.037-.687.055l2.168 6.282.599-1.947c.259-.809.457-1.389.457-1.889zm-3.945.806l-1.8 5.095a6.148 6.148 0 0 0 3.687-.093.52.52 0 0 1-.043-.081L8.105 8.511zm5.16-3.315c.026.186.04.386.04.601 0 .593-.114 1.259-.456 2.093l-1.833 5.16c1.784-1.013 2.983-2.895 2.983-5.051a5.697 5.697 0 0 0-.735-2.803zM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm0 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14z"/> </g></symbol> <symbol id="icon-youtube" viewBox="0 0 16 16"><g> <path d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359 0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z"/> </g></symbol></svg>
  <header class="l-header">
    
<nav class="l-nav p-menu">
  <ul class="p-menu__lists">
    
      
      <li class="p-menu__listitem">
        <a href="localhost/">Home</a>
      </li>
      
    
      
      <li class="p-menu__listitem">
        <a href="localhost/posts">Posts</a>
      </li>
      
    
      
      <li class="p-menu__listitem">
        <a href="localhost/about">About</a>
      </li>
      
    
  </ul>
</nav>


    
    

    
    
  </header>
  <main id="main" class="l-main">


<article class="p-article">
  <header>
    <h1>upload-labs 通关笔记</h1>
    <div>
      <div class="c-time">
        Posted on
        <time datetime="2018-11-24T15:41:37Z">
          Nov 24, 2018
        </time>
      </div>
      
      <a href="/localhost/tags/upload-labs" class="c-tag">upload-labs</a>
      
    </div>
  </header>
  
  <section id="js-article" class="p-article__body">
    <h1 id="upload-labs-通关笔记">upload-labs 通关笔记</h1>
<h2 id="前言">前言</h2>
<p>把上传的所有类型的漏洞都过一遍，然后做一个笔记，方便以后查看，在此也很感谢<a href="https://github.com/c0ny1">c0ny1</a>大佬的平台。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/mind-map.png" alt=""></p>
<h2 id="运行环境">运行环境</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">php版本：推荐5.2.17(其他版本可能会导致部分Pass无法突破)
php组件：php_gd2,php_exif（部分Pass需要开启这两个组件）
apache：以moudel方式连接
</code></pre></div><p>PS：为了节省时间，可下载<a href="https://github.com/c0ny1/upload-labs/releases">Windows下集成环境</a>，解压即可运行靶机环境。</p>
<!-- raw HTML omitted -->
<h2 id="pass-01">Pass-01</h2>
<p>我比较喜欢去看代码分析问题，所以仔细分析了程序的构造。</p>
<p>表单上传文件变量是<code>upload_file</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;input class=&#34;input_file&#34; type=&#34;file&#34; name=&#34;upload_file&#34;/&gt;
</code></pre></div><p>再来看下PHP代码,<code>UPLOAD_PATH</code>是在<code>config.php</code>文件里面的常量<code>define(&quot;UPLOAD_PATH&quot;, &quot;../upload/&quot;);</code>,PHP的代码没有什么过滤的，直接就可以上传了。</p>
<p>但是在这个上传这里我弄了很久，因为Linux的一些机制接触比较少，用的环境是CentOS 7，PHP版本是5.4。</p>
<p>上传的时候一直失败，测试了<code>$_FILES</code>里面的参数都没什么问题，<code>upload</code>目录的权限也测试了，临时文件<code>tmp</code>也测试了，还是不行。</p>
<p>一直到下面的<code>move_uploaded_file</code>函数这里，百度了下已有人遇到同样的问题，解决的办法就关掉<code>selinux</code>输入：</p>
<p><code>setenforce 0 </code></p>
<p>就OK了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;../config.php&#39;</span>;
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;../head.php&#39;</span>;
<span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;../menu.php&#39;</span>;

$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {<span style="color:#75715e">//判断UPLOAD_PATH上传目录是否存在
</span><span style="color:#75715e"></span>        $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];<span style="color:#75715e">//获取临时文件名
</span><span style="color:#75715e"></span>        $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>];<span style="color:#75715e">//上传目录+上传时的文件名
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $img_path)){<span style="color:#75715e">//把临时文件移到UPLOAD_PATH目录
</span><span style="color:#75715e"></span>            $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>再往下看<code>&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; onsubmit=&quot;return checkFile()&quot;&gt;</code></p>
<p>Get到javascript的知识点：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">onsubmit</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;return false;&#34;</span> <span style="color:#a6e22e">将无论何时都阻止表单的提交</span>
<span style="color:#a6e22e">onsubmit</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;return check();&#34;</span> <span style="color:#a6e22e">是否提交表单取决于check</span>()<span style="color:#a6e22e">的返回值</span>
<span style="color:#a6e22e">onsubmit</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;check();&#34;</span> <span style="color:#a6e22e">check</span>()<span style="color:#a6e22e">的返回值无影响</span>
</code></pre></div><p>再往下看js的代码段,<code>getElementsByName</code>取<code>name</code>的值，<code>getElementsById</code>取的是<code>id</code>，取到的值如图所示</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/1.png" alt=""></p>
<p><code> if (file == null || file == &quot;&quot;)</code>这段引来了一个思考，两个都是表示0为什么还有重复去判断呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">null：代表声明了一个空对象，不是一个字符串，可以赋给任何对象，是没有地址。
&#34;&#34;：代表声明了一个对象实例，这个对象实例的值是一个长度为0的空字符串，是有地址但是里面的内容是空的。
</code></pre></div><p>下面的判断文件上传的函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">
<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text/javascript&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">checkFile</span>() {
        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">getElementsByName</span>(<span style="color:#e6db74">&#39;upload_file&#39;</span>)[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">value</span>;
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span>) {
            <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#34;请选择要上传的文件!&#34;</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
        }
        <span style="color:#75715e">//定义允许上传的文件类型
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">allow_ext</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.jpg|.png|.gif&#34;</span>;
        <span style="color:#75715e">//提取上传文件的类型
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ext_name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">substring</span>(<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">lastIndexOf</span>(<span style="color:#e6db74">&#34;.&#34;</span>));<span style="color:#75715e">//eg. shell.php   ext_name=&#39;php&#39;
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//判断上传文件类型是否允许上传
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">allow_ext</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#a6e22e">ext_name</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {<span style="color:#75715e">//如果ext_name不在allow_ext里面
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">errMsg</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;该文件不允许上传，请上传&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">allow_ext</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;类型的文件,当前文件类型为：&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">ext_name</span>;
            <span style="color:#a6e22e">alert</span>(<span style="color:#a6e22e">errMsg</span>);
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
        }
    }
<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;</span>
</code></pre></div><p>由于是前端限制文件的后缀，可以有以下几种方法：</p>
<h3 id="1修改js脚本">1.修改JS脚本</h3>
<p>网上的方法是通过修改js的<code>allow_txt</code>的内容或者删掉<code>onsubmit=&quot;return checkFile()</code>禁止触发js函数</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/2.png" alt=""></p>
<p>但是这个方法我今天测试不成功，删掉<code>onsubmit=&quot;return checkFile()</code>在火狐浏览器就能成功上传，所以在做渗透的时候，一个浏览器不行换一个浏览器试试，总会有新突破。</p>
<p>我本地写了一个上传的页面，测试成功!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">form</span> <span style="color:#a6e22e">enctype</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;multipart/form-data&#34;</span> <span style="color:#a6e22e">method</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;post&#34;</span>  <span style="color:#a6e22e">action</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://192.168.1.103/upload-labs/Pass-01/index.php&#34;</span>&gt;
&lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input_file&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;file&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;upload_file&#34;</span>/&gt;
&lt;<span style="color:#f92672">input</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;button&#34;</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;submit&#34;</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;上传&#34;</span>/&gt;
</code></pre></div><h3 id="2禁止浏览器运行js">2.禁止浏览器运行JS</h3>
<p>以Chomre为例子，进入设置-&gt;内容，把js禁止,然后去上传php成功！</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/3.png" alt=""></p>
<h3 id="3burp抓包改包">3.burp抓包改包</h3>
<p>先上传一个PHP图片马，然后抓包修改后缀就行了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/4.png" alt=""></p>
<h2 id="pass-02">Pass-02</h2>
<p>第二关代码是判断MIME类型的,关于Content-Type的内容可以看https://www.cnblogs.com/52fhy/p/5436673.html</p>
<p>修改text/php 改成<code>image/gif</code>、<code>image/png</code>、<code>image/jpeg</code>其中一个就行了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/5.png" alt=""></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        <span style="color:#66d9ef">if</span> (($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;image/jpeg&#39;</span>) <span style="color:#f92672">||</span> ($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;image/png&#39;</span>) <span style="color:#f92672">||</span> ($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;image/gif&#39;</span>)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]            
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $img_path)) {
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            } <span style="color:#66d9ef">else</span> {
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;文件类型不正确，请重新上传！&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}
</code></pre></div><h2 id="pass-03">Pass-03</h2>
<p>这一关我参考了<code>s1ye</code>的文章http://www.evi1.cn/2018/08/18/upload-labs%E9%80%9A%E5%85%B3%E6%8C%87%E5%8D%97/</p>
<p>他说的</p>
<blockquote>
<p>PS:上传test.php. .适用于pass01-pass09。</p>
</blockquote>
<p>实验中是不行的，因为<code>common.php</code>代码里面都把后面的<code>.</code>过滤了但是代码里面<code>$file_ext</code>取得文件后缀就不成立了，而且他发文章是2018年08月18日，但是GitHub上的是距今2018年11月，6个月前，那么就在5月份之后更新就没做修改了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">#common.php
</span><span style="color:#75715e"></span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deldot</span>($s){
	<span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($s)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;$i<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">--</span>){<span style="color:#f92672">/</span>
		$c <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($s,$i,<span style="color:#ae81ff">1</span>);<span style="color:#75715e">//
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>($i <span style="color:#f92672">==</span> <span style="color:#a6e22e">strlen</span>($s)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> $c <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>){
			<span style="color:#66d9ef">return</span> $s;
		}

		<span style="color:#66d9ef">if</span>($c <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>){
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">substr</span>($s,<span style="color:#ae81ff">0</span>,$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
		}
	}
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>看下代码，过滤文件后面的<code>.</code>和<code>.asp,.aspx,.php,.jsp</code>这几个文件后缀。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        $deny_ext <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;.asp&#39;</span>,<span style="color:#e6db74">&#39;.aspx&#39;</span>,<span style="color:#e6db74">&#39;.php&#39;</span>,<span style="color:#e6db74">&#39;.jsp&#39;</span>);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">deldot</span>($file_name);<span style="color:#75715e">//删除文件名末尾的点
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strrchr</span>($file_name, <span style="color:#e6db74">&#39;.&#39;</span>);<span style="color:#75715e">//取文件后缀名
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($file_ext); <span style="color:#75715e">//转换为小写
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($file_ext); <span style="color:#75715e">//收尾去空
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($file_ext, $deny_ext)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1000</span>,<span style="color:#ae81ff">9999</span>)<span style="color:#f92672">.</span>$file_ext;            
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file,$img_path)) {
                 $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            } <span style="color:#66d9ef">else</span> {
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}

</code></pre></div><h3 id="apache解析漏洞">Apache解析漏洞</h3>
<p>但是我们晓得Apache有解析漏洞，文件在<code>/etc/mime.types</code>。我在CetnOS上面安装的默认没有解析这几行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">application/x-httpd-php          phtml pht php
application/x-httpd-php-source           phps
application/x-httpd-php3         php3
application/x-httpd-php3-preprocessed        php3p
application/x-httpd-php4         php4
application/x-httpd-php5         php5
</code></pre></div><p>我添加一行<code>phtml</code>作为测试，修改后记得<code>service httpd restart</code>或者<code>systemctl restart httpd.service</code></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/6.png" alt=""></p>
<p>上传的时候把后缀改为<code>phtml</code>或者<code>pht</code>，</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/7.png" alt=""></p>
<p>成功解析</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/8.png" alt=""></p>
<h2 id="pass-04">Pass-04</h2>
<p>第四关代码显示有一个错误，运行的代码是没有改上传文件名的，但是显示的代码是用时间日期作为文件的命名的。用黑名单过滤了大部分的问题后缀，但是有一个Apache的<code>.htaccess</code>没有过滤。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        $deny_ext <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;.php&#34;</span>,<span style="color:#e6db74">&#34;.php5&#34;</span>,<span style="color:#e6db74">&#34;.php4&#34;</span>,<span style="color:#e6db74">&#34;.php3&#34;</span>,<span style="color:#e6db74">&#34;.php2&#34;</span>,<span style="color:#e6db74">&#34;php1&#34;</span>,<span style="color:#e6db74">&#34;.html&#34;</span>,<span style="color:#e6db74">&#34;.htm&#34;</span>,<span style="color:#e6db74">&#34;.phtml&#34;</span>,<span style="color:#e6db74">&#34;.pht&#34;</span>,<span style="color:#e6db74">&#34;.pHp&#34;</span>,<span style="color:#e6db74">&#34;.pHp5&#34;</span>,<span style="color:#e6db74">&#34;.pHp4&#34;</span>,<span style="color:#e6db74">&#34;.pHp3&#34;</span>,<span style="color:#e6db74">&#34;.pHp2&#34;</span>,<span style="color:#e6db74">&#34;pHp1&#34;</span>,<span style="color:#e6db74">&#34;.Html&#34;</span>,<span style="color:#e6db74">&#34;.Htm&#34;</span>,<span style="color:#e6db74">&#34;.pHtml&#34;</span>,<span style="color:#e6db74">&#34;.jsp&#34;</span>,<span style="color:#e6db74">&#34;.jspa&#34;</span>,<span style="color:#e6db74">&#34;.jspx&#34;</span>,<span style="color:#e6db74">&#34;.jsw&#34;</span>,<span style="color:#e6db74">&#34;.jsv&#34;</span>,<span style="color:#e6db74">&#34;.jspf&#34;</span>,<span style="color:#e6db74">&#34;.jtml&#34;</span>,<span style="color:#e6db74">&#34;.jSp&#34;</span>,<span style="color:#e6db74">&#34;.jSpx&#34;</span>,<span style="color:#e6db74">&#34;.jSpa&#34;</span>,<span style="color:#e6db74">&#34;.jSw&#34;</span>,<span style="color:#e6db74">&#34;.jSv&#34;</span>,<span style="color:#e6db74">&#34;.jSpf&#34;</span>,<span style="color:#e6db74">&#34;.jHtml&#34;</span>,<span style="color:#e6db74">&#34;.asp&#34;</span>,<span style="color:#e6db74">&#34;.aspx&#34;</span>,<span style="color:#e6db74">&#34;.asa&#34;</span>,<span style="color:#e6db74">&#34;.asax&#34;</span>,<span style="color:#e6db74">&#34;.ascx&#34;</span>,<span style="color:#e6db74">&#34;.ashx&#34;</span>,<span style="color:#e6db74">&#34;.asmx&#34;</span>,<span style="color:#e6db74">&#34;.cer&#34;</span>,<span style="color:#e6db74">&#34;.aSp&#34;</span>,<span style="color:#e6db74">&#34;.aSpx&#34;</span>,<span style="color:#e6db74">&#34;.aSa&#34;</span>,<span style="color:#e6db74">&#34;.aSax&#34;</span>,<span style="color:#e6db74">&#34;.aScx&#34;</span>,<span style="color:#e6db74">&#34;.aShx&#34;</span>,<span style="color:#e6db74">&#34;.aSmx&#34;</span>,<span style="color:#e6db74">&#34;.cEr&#34;</span>,<span style="color:#e6db74">&#34;.sWf&#34;</span>,<span style="color:#e6db74">&#34;.swf&#34;</span>);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">deldot</span>($file_name);<span style="color:#75715e">//删除文件名末尾的点
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strrchr</span>($file_name, <span style="color:#e6db74">&#39;.&#39;</span>);
        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($file_ext); <span style="color:#75715e">//转换为小写
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($file_ext); <span style="color:#75715e">//收尾去空
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($file_ext, $deny_ext)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            <span style="color:#75715e">//$img_path = UPLOAD_PATH.&#39;/&#39;.date(&#34;YmdHis&#34;).rand(1000,9999).$file_ext;
</span><span style="color:#75715e"></span>            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span>$file_name;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $img_path)) {
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            } <span style="color:#66d9ef">else</span> {
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;此文件不允许上传!&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}

</code></pre></div><h3 id="htaccess分布式配置文件">.htaccess（分布式配置文件）</h3>
<p><code>.htaccess</code>是Apache的又一特色。一般来说，配置文件的作用范围都是全局的，但Apache提供了一种很方便的、可作用于当前目录及其子目录的配置文件。</p>
<p>Apache的配置文件在<code>/etc/httpd/conf</code>下面的<code>httpd.conf</code></p>
<p>要想使.htaccess文件生效，需要两个条件，一是在Apache的配置文件中写上：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">AllowOverride

</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/9.png" alt=""></p>
<p>二是Apache要加载mod_Rewrite模块。加载该模块，需要在Apache的配置文件中写上：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so
</code></pre></div><p>新版的Apache配置文件包含在<code>/etc/httpd/conf.modules.d</code>里面</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/10.png" alt="">我们只需打开里面的<code>00-base.conf</code>修改就行了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/11.png" alt=""></p>
<p>重启服务器<code>service httpd restart</code>或者<code>systemctl restart httpd.service</code></p>
<p>如果是<code>Ubuntu</code>则需要</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">sudo a2enmod rewrite
</code></pre></div><p><code>.htaccess</code>文件可以配置很多事情，如是否开启站点的图片缓存、自定义错误页面、自定义默认文档、设置WWW域名重定向、设置网页重定向、设置图片防盗链和访问权限控制。但我们这里只关心<code>.htaccess</code>文件的一个作用——MIME类型修改。</p>
<p>有两种写法：</p>
<p><strong>第一种</strong></p>
<p>先上传<code>.htaccess</code>内容为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">AddType application/x-httpd-php jpg
</code></pre></div><p>意思是：网站的<code>jpg</code>后缀都作为php文件来执行</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/12.png" alt=""></p>
<p>我们上传一个测试图片看看效果</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/13.png" alt=""></p>
<p><strong>第二种</strong></p>
<p>可以把<code>.htaccess</code>的内容修改为</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;FilesMatch &#34;test&#34;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre></div><p>或者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">&lt;FilesMatch &#34;test.jpg&#34;&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre></div><p>第一个会把test.xxx的文件解析为php文件，第二个只会把文件名为test.jpg的文件解析为php</p>
<p>我们尝试第二个看看效果</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/14.png" alt=""></p>
<p>也是能成功解析的</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/13.png" alt=""></p>
<h2 id="pass-05">Pass-05</h2>
<p>这一关我又看到http://www.evi1.cn/2018/08/18/upload-labs%E9%80%9A%E5%85%B3%E6%8C%87%E5%8D%97/</p>
<p>的作者用<code>.php. . </code>的用法了，我仔细看了几遍<code>common.php</code>的代码，感觉没错啊，对不起我确实是一个杠精，我用Windows搭建了测试,测试还是失败的,问题出现在<code>$img_path</code>的变量</p>
<p><strong>Linux</strong></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/15.png" alt=""></p>
<p><strong>Windows</strong></p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/16.png" alt=""></p>
<blockquote>
<p>该函数简单明了，就是消掉末尾的点。也就是说只要构造”.php. .”即可绕过检测，当<code>deldot</code>函数检测到末尾的第一个点时将继续从后向前检测，当检测到空格时return xxx.php. (这里结尾时空格),接下来执行trim函数将去掉末尾的空格，最终文件名为 test.php. 由于windows特性，最后将变为test.php。</p>
</blockquote>
<p>我们仔细分析下这段代码的作用吧，这里确实会返回<code>xx.php.</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">deldot</span>($s){
	<span style="color:#66d9ef">for</span>($i <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>($s)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;$i<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>;$i<span style="color:#f92672">--</span>){
		$c <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($s,$i,<span style="color:#ae81ff">1</span>);
		<span style="color:#66d9ef">if</span>($i <span style="color:#f92672">==</span> <span style="color:#a6e22e">strlen</span>($s)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">and</span> $c <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>){
			<span style="color:#66d9ef">return</span> $s;
		}

		<span style="color:#66d9ef">if</span>($c <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;.&#39;</span>){
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">substr</span>($s,<span style="color:#ae81ff">0</span>,$i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
		}
	}
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>但是到这里就不一样了，取后缀为空,作者估计<code>strrchr</code>有理解错误，误以为是取第一个<code>.</code>然后取后面的字符,</p>
<p><code>$file_ext = strrchr($file_name, '.');</code></p>
<p>测试语句返回来的值是<code>.</code></p>
<p><code> echo strrchr('1.php.','.');</code></p>
<p>官方的解释：</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/17.png" alt=""></p>
<p>然后组成后缀</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$img_path = UPLOAD_PATH.&#39;/&#39;.date(&#34;YmdHis&#34;).rand(1000,9999).$file_ext;
</code></pre></div><p>那么我们上传后就会变成<code>2018xxxx.</code></p>
<p>第五关的代码分析，没有用<code>strtolower</code>来转化大小写，所以用大小写来突破<code>pHp</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        $deny_ext <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;.php&#34;</span>,<span style="color:#e6db74">&#34;.php5&#34;</span>,<span style="color:#e6db74">&#34;.php4&#34;</span>,<span style="color:#e6db74">&#34;.php3&#34;</span>,<span style="color:#e6db74">&#34;.php2&#34;</span>,<span style="color:#e6db74">&#34;.html&#34;</span>,<span style="color:#e6db74">&#34;.htm&#34;</span>,<span style="color:#e6db74">&#34;.phtml&#34;</span>,<span style="color:#e6db74">&#34;.pht&#34;</span>,<span style="color:#e6db74">&#34;.pHp&#34;</span>,<span style="color:#e6db74">&#34;.pHp5&#34;</span>,<span style="color:#e6db74">&#34;.pHp4&#34;</span>,<span style="color:#e6db74">&#34;.pHp3&#34;</span>,<span style="color:#e6db74">&#34;.pHp2&#34;</span>,<span style="color:#e6db74">&#34;.Html&#34;</span>,<span style="color:#e6db74">&#34;.Htm&#34;</span>,<span style="color:#e6db74">&#34;.pHtml&#34;</span>,<span style="color:#e6db74">&#34;.jsp&#34;</span>,<span style="color:#e6db74">&#34;.jspa&#34;</span>,<span style="color:#e6db74">&#34;.jspx&#34;</span>,<span style="color:#e6db74">&#34;.jsw&#34;</span>,<span style="color:#e6db74">&#34;.jsv&#34;</span>,<span style="color:#e6db74">&#34;.jspf&#34;</span>,<span style="color:#e6db74">&#34;.jtml&#34;</span>,<span style="color:#e6db74">&#34;.jSp&#34;</span>,<span style="color:#e6db74">&#34;.jSpx&#34;</span>,<span style="color:#e6db74">&#34;.jSpa&#34;</span>,<span style="color:#e6db74">&#34;.jSw&#34;</span>,<span style="color:#e6db74">&#34;.jSv&#34;</span>,<span style="color:#e6db74">&#34;.jSpf&#34;</span>,<span style="color:#e6db74">&#34;.jHtml&#34;</span>,<span style="color:#e6db74">&#34;.asp&#34;</span>,<span style="color:#e6db74">&#34;.aspx&#34;</span>,<span style="color:#e6db74">&#34;.asa&#34;</span>,<span style="color:#e6db74">&#34;.asax&#34;</span>,<span style="color:#e6db74">&#34;.ascx&#34;</span>,<span style="color:#e6db74">&#34;.ashx&#34;</span>,<span style="color:#e6db74">&#34;.asmx&#34;</span>,<span style="color:#e6db74">&#34;.cer&#34;</span>,<span style="color:#e6db74">&#34;.aSp&#34;</span>,<span style="color:#e6db74">&#34;.aSpx&#34;</span>,<span style="color:#e6db74">&#34;.aSa&#34;</span>,<span style="color:#e6db74">&#34;.aSax&#34;</span>,<span style="color:#e6db74">&#34;.aScx&#34;</span>,<span style="color:#e6db74">&#34;.aShx&#34;</span>,<span style="color:#e6db74">&#34;.aSmx&#34;</span>,<span style="color:#e6db74">&#34;.cEr&#34;</span>,<span style="color:#e6db74">&#34;.sWf&#34;</span>,<span style="color:#e6db74">&#34;.swf&#34;</span>,<span style="color:#e6db74">&#34;.htaccess&#34;</span>);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>]);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">deldot</span>($file_name);<span style="color:#75715e">//删除文件名末尾的点
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strrchr</span>($file_name, <span style="color:#e6db74">&#39;.&#39;</span>);
        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($file_ext); <span style="color:#75715e">//首尾去空
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($file_ext, $deny_ext)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1000</span>,<span style="color:#ae81ff">9999</span>)<span style="color:#f92672">.</span>$file_ext;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $img_path)) {
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            } <span style="color:#66d9ef">else</span> {
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;此文件类型不允许上传！&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}

</code></pre></div><p>在Windows上面可以正常解析，Linux严格大小写所以看环境，下面是Windows的解析结果</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/18.png" alt=""></p>
<h2 id="pass-06">Pass-06</h2>
<p>第六关少了</p>
<p><code>$file_ext = trim($file_ext); //首尾去空</code></p>
<p>所以在<code>1.php </code>这里后面加一个空格可以绕过</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        $deny_ext <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;.php&#34;</span>,<span style="color:#e6db74">&#34;.php5&#34;</span>,<span style="color:#e6db74">&#34;.php4&#34;</span>,<span style="color:#e6db74">&#34;.php3&#34;</span>,<span style="color:#e6db74">&#34;.php2&#34;</span>,<span style="color:#e6db74">&#34;.html&#34;</span>,<span style="color:#e6db74">&#34;.htm&#34;</span>,<span style="color:#e6db74">&#34;.phtml&#34;</span>,<span style="color:#e6db74">&#34;.pht&#34;</span>,<span style="color:#e6db74">&#34;.pHp&#34;</span>,<span style="color:#e6db74">&#34;.pHp5&#34;</span>,<span style="color:#e6db74">&#34;.pHp4&#34;</span>,<span style="color:#e6db74">&#34;.pHp3&#34;</span>,<span style="color:#e6db74">&#34;.pHp2&#34;</span>,<span style="color:#e6db74">&#34;.Html&#34;</span>,<span style="color:#e6db74">&#34;.Htm&#34;</span>,<span style="color:#e6db74">&#34;.pHtml&#34;</span>,<span style="color:#e6db74">&#34;.jsp&#34;</span>,<span style="color:#e6db74">&#34;.jspa&#34;</span>,<span style="color:#e6db74">&#34;.jspx&#34;</span>,<span style="color:#e6db74">&#34;.jsw&#34;</span>,<span style="color:#e6db74">&#34;.jsv&#34;</span>,<span style="color:#e6db74">&#34;.jspf&#34;</span>,<span style="color:#e6db74">&#34;.jtml&#34;</span>,<span style="color:#e6db74">&#34;.jSp&#34;</span>,<span style="color:#e6db74">&#34;.jSpx&#34;</span>,<span style="color:#e6db74">&#34;.jSpa&#34;</span>,<span style="color:#e6db74">&#34;.jSw&#34;</span>,<span style="color:#e6db74">&#34;.jSv&#34;</span>,<span style="color:#e6db74">&#34;.jSpf&#34;</span>,<span style="color:#e6db74">&#34;.jHtml&#34;</span>,<span style="color:#e6db74">&#34;.asp&#34;</span>,<span style="color:#e6db74">&#34;.aspx&#34;</span>,<span style="color:#e6db74">&#34;.asa&#34;</span>,<span style="color:#e6db74">&#34;.asax&#34;</span>,<span style="color:#e6db74">&#34;.ascx&#34;</span>,<span style="color:#e6db74">&#34;.ashx&#34;</span>,<span style="color:#e6db74">&#34;.asmx&#34;</span>,<span style="color:#e6db74">&#34;.cer&#34;</span>,<span style="color:#e6db74">&#34;.aSp&#34;</span>,<span style="color:#e6db74">&#34;.aSpx&#34;</span>,<span style="color:#e6db74">&#34;.aSa&#34;</span>,<span style="color:#e6db74">&#34;.aSax&#34;</span>,<span style="color:#e6db74">&#34;.aScx&#34;</span>,<span style="color:#e6db74">&#34;.aShx&#34;</span>,<span style="color:#e6db74">&#34;.aSmx&#34;</span>,<span style="color:#e6db74">&#34;.cEr&#34;</span>,<span style="color:#e6db74">&#34;.sWf&#34;</span>,<span style="color:#e6db74">&#34;.swf&#34;</span>,<span style="color:#e6db74">&#34;.htaccess&#34;</span>);
        $file_name <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>];
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">deldot</span>($file_name);<span style="color:#75715e">//删除文件名末尾的点
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strrchr</span>($file_name, <span style="color:#e6db74">&#39;.&#39;</span>);
        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($file_ext); <span style="color:#75715e">//转换为小写
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span><span style="color:#75715e"></span>        
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($file_ext, $deny_ext)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1000</span>,<span style="color:#ae81ff">9999</span>)<span style="color:#f92672">.</span>$file_ext;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file,$img_path)) {
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            } <span style="color:#66d9ef">else</span> {
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;此文件不允许上传&#39;</span>;
        }
    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}

</code></pre></div><p>在Linux上面测试失败，Linux的机制很严格;在Windows上面测试成功！</p>
<h2 id="pass-07">Pass-07</h2>
<p>第七关还是黑名单，没有用<code>deldot</code>函数，就没有把<code>.</code>去掉</p>
<p>这一句取的是取两边空格的<code>$file_name</code>变量</p>
<p><code> $img_path = UPLOAD_PATH.'/'.$file_name;</code></p>
<p>利用windows特性，会自动去掉后缀名中最后的<code>.</code>，可在后缀名中加<code>.</code>绕过,Linux测试失败。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/19.png" alt=""></p>
<h2 id="pass-08">Pass-08</h2>
<p>代码就不贴了，直接看重要的部分，和上面的区别就是少了一句替换和代码换成了取到后缀名最终的后缀名</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">1000</span>,<span style="color:#ae81ff">9999</span>)<span style="color:#f92672">.</span>$file_ext;
</code></pre></div><p>这样一看，<code>::$DATA'</code>是Windows的特性，具体可以看文章https://www.waitalone.cn/php-windows-upload.html</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/20.png" alt=""></p>
<h2 id="pass-09">Pass-09</h2>
<p>这关用了<code>deldot</code>上面有说这个函数的执行，如果上传的文件名为<code>1.php.（这里是一个空格）.</code>那么得到文件名为<code>$file_ext=.</code>，</p>
<p>但是这里改成</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span>$file_name;
</code></pre></div><p>那么上传后的文件名就应该是<code>1.php.</code></p>
<p>Linux是不能解析了，但Windows会自动把后面的<code>.</code>去掉</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/21.png" alt=""></p>
<h2 id="pass-10">Pass-10</h2>
<p>第十关突破点在这里</p>
<p><code> $file_name = str_ireplace($deny_ext,&quot;&quot;, $file_name);</code></p>
<p><code>$img_path = UPLOAD_PATH.'/'.$file_name;     </code></p>
<p>str_ireplace可以去官网看说明http://php.net/manual/zh/function.str-ireplace.php</p>
<p>搜索有对应的关键词都会替换掉，但只搜索一次，替换没有限制。</p>
<p>可以利用双写绕过</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/22.png" alt=""></p>
<h2 id="pass-11">Pass-11</h2>
<h3 id="00截断">%00截断</h3>
<p>看代码已经用了白名单了，但是这里有一个<code>$_GET['save_path']</code>用<code>get</code>来传递参数后面再加上后缀名</p>
<p>我们可以用%00截断来绕过</p>
<p>在url中%00表示ascll码中的0 ，而ascii中0作为特殊字符保留，表示字符串结束，所以当url中出现%00时就会认为读取已结束。</p>
<p>但是有环境限制：</p>
<blockquote>
<p>php版本要小于5.3.4，5.3.4及以上已经修复该问题</p>
<p>magic_quotes_gpc需要为OFF状态</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$ext_arr <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;jpg&#39;</span>,<span style="color:#e6db74">&#39;png&#39;</span>,<span style="color:#e6db74">&#39;gif&#39;</span>);
    $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>],<span style="color:#a6e22e">strrpos</span>($_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>],<span style="color:#e6db74">&#34;.&#34;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($file_ext,$ext_arr)){
        $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
        $img_path <span style="color:#f92672">=</span> $_GET[<span style="color:#e6db74">&#39;save_path&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">99</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">.</span>$file_ext;

</code></pre></div><p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/23.png" alt=""></p>
<h2 id="pass-12">Pass-12</h2>
<p>和11关区别就在于<code>GET</code>和<code>POST</code>,<code>GET</code>是可以把url自动转码的，但是<code>POST</code>不会，所以我们要做一些改动。</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/24.png" alt=""></p>
<h2 id="pass-13">Pass-13</h2>
<p>这关主要是利用了一个判断文件的函数</p>
<ol>
<li><code>fopen</code>打开文件数据流</li>
<li><code>fread</code>读取2个字节</li>
<li>用<code>unpack</code>对二进制数据进行解包，<code>C</code>代表无符号字节型，后面的<code>2</code>代表个数，也可以用<code>*</code>代替</li>
<li>把两个<code>chars</code>连接起来再用<code>intval</code>转换为整数型</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getReailFileType</span>($filename){
    $file <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>($filename, <span style="color:#e6db74">&#34;rb&#34;</span>);
    $bin <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>($file, <span style="color:#ae81ff">2</span>); <span style="color:#75715e">//只读2字节
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fclose</span>($file);
    $strInfo <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">unpack</span>(<span style="color:#e6db74">&#34;C2chars&#34;</span>, $bin);    
    $typeCode <span style="color:#f92672">=</span> <span style="color:#a6e22e">intval</span>($strInfo[<span style="color:#e6db74">&#39;chars1&#39;</span>]<span style="color:#f92672">.</span>$strInfo[<span style="color:#e6db74">&#39;chars2&#39;</span>]);    
    $fileType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;    
    <span style="color:#66d9ef">switch</span>($typeCode){      
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">255216</span><span style="color:#f92672">:</span>            
            $fileType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;jpg&#39;</span>;
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">13780</span><span style="color:#f92672">:</span>            
            $fileType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;png&#39;</span>;
            <span style="color:#66d9ef">break</span>;        
        <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">7173</span><span style="color:#f92672">:</span>            
            $fileType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gif&#39;</span>;
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>            
            $fileType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;unknown&#39;</span>;
        }    
        <span style="color:#66d9ef">return</span> $fileType;
}

</code></pre></div><p>绕过也比较简单，做一个图片马就行了，这关不要求解析成PHP</p>
<p>具体操作可以参考http://gv7.me/articles/2017/picture-trojan-horse-making-method/</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/25.png" alt=""></p>
<p>上传后</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/26.png" alt=""></p>
<h2 id="pass-14">Pass-14</h2>
<p><code>getimagesize</code>判断图片内置函数可以参考官方文档http://php.net/manual/zh/function.getimagesize.php</p>
<p><code>image_type_to_extension</code>取文件后缀的内置函数http://php.net/manual/zh/function.image-type-to-extension.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isImage</span>($filename){
    $types <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.jpeg|.png|.gif&#39;</span>;
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">file_exists</span>($filename)){
        $info <span style="color:#f92672">=</span> <span style="color:#a6e22e">getimagesize</span>($filename);
        $ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">image_type_to_extension</span>($info[<span style="color:#ae81ff">2</span>]);
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">stripos</span>($types,$ext)){
            <span style="color:#66d9ef">return</span> $ext;
        }<span style="color:#66d9ef">else</span>{
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
        }
    }<span style="color:#66d9ef">else</span>{
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
    }
}
</code></pre></div><p>绕过方法可以用13关的图片马</p>
<h2 id="pass-15">Pass-15</h2>
<p>这关需要开启<code>php_exif</code>模块</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/27.png" alt=""></p>
<p><code>exif_imagetype</code> 也是判断图片的类型的，具体可以看官方文档http://php.net/manual/zh/function.exif-imagetype.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">isImage</span>($filename){
    <span style="color:#75715e">//需要开启php_exif模块
</span><span style="color:#75715e"></span>    $image_type <span style="color:#f92672">=</span> <span style="color:#a6e22e">exif_imagetype</span>($filename);
    <span style="color:#66d9ef">switch</span> ($image_type) {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IMAGETYPE_GIF</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;gif&#34;</span>;
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IMAGETYPE_JPEG</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;jpg&#34;</span>;
            <span style="color:#66d9ef">break</span>;
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IMAGETYPE_PNG</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;png&#34;</span>;
            <span style="color:#66d9ef">break</span>;    
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
            <span style="color:#66d9ef">break</span>;
    }
}

</code></pre></div><h2 id="pass-16">Pass-16</h2>
<p>这关也是上传图片的，三段代差不多，取其中的一段来分析<code> $target_path</code>已经用了<code>basename</code>来限制你修改目录绕过的方法了。</p>
<p><code>$fileext</code>以点为界，取点后面的字符作为后缀名。</p>
<p>变量<code>$filetype</code>获取的值取判断<code>content-type</code>是否符合条件</p>
<p><code>imagecreatefromjpeg</code>判断是否为图片资源，具体可以看官方文档http://php.net/manual/zh/function.imagecreatefromjpeg.php</p>
<p><code> srand(time())</code>看官方文档http://php.net/manual/zh/function.srand.php，和下面的<a href="http://www.php.net/manual/zh/function.strval.php">strval</a><code>(rand())</code> 相结合，随机数发生器的初始化，为了让上传的随机文件名不重复。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])){
    <span style="color:#75715e">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径
</span><span style="color:#75715e"></span>    $filename <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>];
    $filetype <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;type&#39;</span>];
    $tmpname <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];

    $target_path<span style="color:#f92672">=</span><span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span><span style="color:#a6e22e">basename</span>($filename);

    <span style="color:#75715e">// 获得上传文件的扩展名
</span><span style="color:#75715e"></span>    $fileext<span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>(<span style="color:#a6e22e">strrchr</span>($filename,<span style="color:#e6db74">&#34;.&#34;</span>),<span style="color:#ae81ff">1</span>);

    <span style="color:#75715e">//判断文件后缀与类型，合法才进行上传操作
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(($fileext <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;jpg&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> ($filetype<span style="color:#f92672">==</span><span style="color:#e6db74">&#34;image/jpeg&#34;</span>)){
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">move_uploaded_file</span>($tmpname,$target_path))
        {
            <span style="color:#75715e">//使用上传的图片生成新的图片
</span><span style="color:#75715e"></span>            $im <span style="color:#f92672">=</span> <span style="color:#a6e22e">imagecreatefromjpeg</span>($target_path);

            <span style="color:#66d9ef">if</span>($im <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span>){
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;该文件不是jpg格式的图片！&#34;</span>;
                <span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>($target_path);
            }<span style="color:#66d9ef">else</span>{
                <span style="color:#75715e">//给新图片指定文件名
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">srand</span>(<span style="color:#a6e22e">time</span>());
                $newfilename <span style="color:#f92672">=</span> <span style="color:#a6e22e">strval</span>(<span style="color:#a6e22e">rand</span>())<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.jpg&#34;</span>;
                $newimagepath <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span>$newfilename;
                <span style="color:#a6e22e">imagejpeg</span>($im,$newimagepath);
                <span style="color:#75715e">//显示二次渲染后的图片（使用用户上传图片生成的新图片）
</span><span style="color:#75715e"></span>                $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span><span style="color:#f92672">.</span>$newfilename;
                <span style="color:#f92672">@</span><span style="color:#a6e22e">unlink</span>($target_path);
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            }
        } <span style="color:#66d9ef">else</span> {
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;上传出错！&#34;</span>;
        }

    }
</code></pre></div><p>imagecreatefromjpeg二次渲染它相当于是把原本属于图像数据的部分抓了出来，再用自己的API 或函数进行重新渲染在这个过程中非图像数据的部分直接就隔离开了。</p>
<p>绕过方法https://secgeek.net/bookfresh-vulnerability/ ，可以用里面的图片，具体怎么写exp在这里留个坑，改天再写个文章单独研究</p>
<h2 id="pass-17">Pass-17</h2>
<p>这关是无论是什么文件先上传了再说，然后通过白名单检测后缀名，符合就<code>rename</code>改名，不符合就<code>unlink</code>删除文件。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">
$is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
$msg <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;

<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])){
    $ext_arr <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;jpg&#39;</span>,<span style="color:#e6db74">&#39;png&#39;</span>,<span style="color:#e6db74">&#39;gif&#39;</span>);
    $file_name <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;name&#39;</span>];
    $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
    $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($file_name,<span style="color:#a6e22e">strrpos</span>($file_name,<span style="color:#e6db74">&#34;.&#34;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
    $upload_file <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span> $file_name;

    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $upload_file)){
        <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($file_ext,$ext_arr)){
             $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">.</span> <span style="color:#a6e22e">rand</span>(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">99</span>)<span style="color:#f92672">.</span><span style="color:#a6e22e">date</span>(<span style="color:#e6db74">&#34;YmdHis&#34;</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.&#34;</span><span style="color:#f92672">.</span>$file_ext;
             <span style="color:#a6e22e">rename</span>($upload_file, $img_path);
             $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
        }<span style="color:#66d9ef">else</span>{
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;只允许上传.jpg|.png|.gif类型文件！&#34;</span>;
            <span style="color:#a6e22e">unlink</span>($upload_file);
        }
    }<span style="color:#66d9ef">else</span>{
        $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
    }
}
</code></pre></div><p>但存在竞争条件，具体可以看文章http://homakov.blogspot.com/2014/11/hacking-file-uploaders-with-race.html</p>
<p>可以用burp来发包不断访问，先写一个php写入文件的<code>test.php</code>然后在访问这文件就可以生成另外一个shell了</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/28.png" alt=""></p>
<h2 id="pass-18">Pass-18</h2>
<p>这关还是同样的竞争条件，<code>index.php</code>调用了<code>MyUpload</code>这关上传类，使用了<code>upload</code>方法，执行的顺序是先上传然后再改名，但如何快速的多线程上传那就会出现bug，</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">upload</span>( $dir ){
    
    $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isUploadedFile</span>();
    
    <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
      <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );
    }

    $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">setDir</span>( $dir );
    <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
      <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );
    }

    $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checkExtension</span>();
    <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
      <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );
    }

    $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checkSize</span>();
    <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
      <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );    
    }
    
    <span style="color:#75715e">// if flag to check if the file exists is set to 1
</span><span style="color:#75715e"></span>    
    <span style="color:#66d9ef">if</span>( $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cls_file_exists</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> ){
      
      $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">checkFileExists</span>();
      <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );    
      }
    }

    <span style="color:#75715e">// if we are here, we are ready to move the file to destination
</span><span style="color:#75715e"></span>
    $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">move</span>();
    <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
      <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );    
    }

    <span style="color:#75715e">// check if we need to rename the file
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span>( $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">cls_rename_file</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> ){
      $ret <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">renameFile</span>();
      <span style="color:#66d9ef">if</span>( $ret <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> ){
        <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( $ret );    
      }
    }
    
    <span style="color:#75715e">// if we are here, everything worked as planned :)
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">return</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">resultUpload</span>( <span style="color:#e6db74">&#34;SUCCESS&#34;</span> );
  
  }
</code></pre></div><p>绕过方法和上一关的一样，但是这关在上传之前用了白名单来检测，所以只能上传图片马，用Apache解析漏洞或者是文件包含漏洞。</p>
<h2 id="pass-19">Pass-19</h2>
<p>这关<code> $file_name = trim($_POST['save_name']);</code>这里是决定上传后的文件名，有黑名单，而且这关要我们上传的是webshell</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#39;submit&#39;</span>])) {
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">file_exists</span>(<span style="color:#a6e22e">UPLOAD_PATH</span>)) {
        $deny_ext <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;php&#34;</span>,<span style="color:#e6db74">&#34;php5&#34;</span>,<span style="color:#e6db74">&#34;php4&#34;</span>,<span style="color:#e6db74">&#34;php3&#34;</span>,<span style="color:#e6db74">&#34;php2&#34;</span>,<span style="color:#e6db74">&#34;html&#34;</span>,<span style="color:#e6db74">&#34;htm&#34;</span>,<span style="color:#e6db74">&#34;phtml&#34;</span>,<span style="color:#e6db74">&#34;pht&#34;</span>,<span style="color:#e6db74">&#34;jsp&#34;</span>,<span style="color:#e6db74">&#34;jspa&#34;</span>,<span style="color:#e6db74">&#34;jspx&#34;</span>,<span style="color:#e6db74">&#34;jsw&#34;</span>,<span style="color:#e6db74">&#34;jsv&#34;</span>,<span style="color:#e6db74">&#34;jspf&#34;</span>,<span style="color:#e6db74">&#34;jtml&#34;</span>,<span style="color:#e6db74">&#34;asp&#34;</span>,<span style="color:#e6db74">&#34;aspx&#34;</span>,<span style="color:#e6db74">&#34;asa&#34;</span>,<span style="color:#e6db74">&#34;asax&#34;</span>,<span style="color:#e6db74">&#34;ascx&#34;</span>,<span style="color:#e6db74">&#34;ashx&#34;</span>,<span style="color:#e6db74">&#34;asmx&#34;</span>,<span style="color:#e6db74">&#34;cer&#34;</span>,<span style="color:#e6db74">&#34;swf&#34;</span>,<span style="color:#e6db74">&#34;htaccess&#34;</span>);

        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($_POST[<span style="color:#e6db74">&#39;save_name&#39;</span>]);
        $file_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">deldot</span>($file_name);<span style="color:#75715e">//删除文件名末尾的点
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">pathinfo</span>($file_name,<span style="color:#a6e22e">PATHINFO_EXTENSION</span>);
        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtolower</span>($file_ext); <span style="color:#75715e">//转换为小写
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">str_ireplace</span>(<span style="color:#e6db74">&#39;::$DATA&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $file_ext);<span style="color:#75715e">//去除字符串::$DATA
</span><span style="color:#75715e"></span>        $file_ext <span style="color:#f92672">=</span> <span style="color:#a6e22e">trim</span>($file_ext); <span style="color:#75715e">//首尾去空
</span><span style="color:#75715e"></span>
        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">in_array</span>($file_ext,$deny_ext)) {
            $temp_file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;upload_file&#39;</span>][<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
            $img_path <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">.</span>$file_name;
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">move_uploaded_file</span>($temp_file, $img_path)) { 
                $is_upload <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            }<span style="color:#66d9ef">else</span>{
                $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;上传出错！&#39;</span>;
            }
        }<span style="color:#66d9ef">else</span>{
            $msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;禁止保存为该类型文件！&#39;</span>;
        }

    } <span style="color:#66d9ef">else</span> {
        $msg <span style="color:#f92672">=</span> <span style="color:#a6e22e">UPLOAD_PATH</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;文件夹不存在,请手工创建！&#39;</span>;
    }
}
<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>我们可以用<code>CVE-2015-2348</code><a href="https://www.cnblogs.com/cyjaysun/p/4390930.html">https://www.cnblogs.com/cyjaysun/p/4390930.html</a>  漏洞绕过</p>
<p><img src="https://pic-1252849007.cos.ap-guangzhou.myqcloud.com/upload-labs/29.png" alt=""></p>
<h2 id="总结">总结</h2>
<p>用两周才写完这个笔记，主要是懒，不过加深了上传方面的知识还是收获到很多。</p>
<p>上面有什么错漏的欢迎留言。</p>

  </section>
  <footer>
    
    
    <nav class="p-pagination c-pagination">
      <div class="c-pagination__ctrl">
        <div class="c-pagination__newer">
          
          <a href="localhost/posts/finecms-5.0.10-multiple-vulnerabilities/">Newer</a>
          
        </div>
        <div class="c-pagination__older">
          
          <a href="localhost/posts/thinkphp5-remote-code-execution-vulnerability-dynamic-analysis/">Older</a>
          
        </div>
      </div>
    </nav>
    
    


  </footer>
</article>
  </main>
  <footer class="l-footer">
    


    <p class="p-copyright">
      
        &copy; Copyright F0rmat
      
    </p>
  </footer>

  

</body>
</html>

